<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>HabitOS — Study Star</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="HabitOS">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: #07080f;
      color: #e5e9ff;
    }

    canvas {
      position: fixed;
      inset: 0;
      z-index: 0;
    }

    /* 上方：最近 28 天的小星星 */
    #history {
      position: fixed;
      top: calc(env(safe-area-inset-top, 10px) + 8px);
      left: 12px;
      right: 12px;
      z-index: 5;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 11px;
      color: #9ca8ff;
    }
    #historyLabel {
      opacity: 0.8;
    }
    #historyBar {
      display: grid;
      grid-template-columns: repeat(14, 1fr);
      gap: 4px;
    }
    .historyDay {
      width: 14px;
      height: 14px;
      border-radius: 4px;
      background: #1b2035;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: #4f5a88;
    }
    .historyDay.active {
      background: #ffd95c;
      color: #5a4100;
      box-shadow: 0 0 8px #ffd95c;
    }

    /* 中間大星星 */
    #center {
      position: fixed;
      top: 52%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 5;
      text-align: center;
      text-shadow: 0 0 12px rgba(0,0,0,0.7);
      padding: 0 20px;
    }

    #bigStar {
      font-size: 96px;
      margin-bottom: 8px;
      transition: transform 0.2s ease-out, text-shadow 0.2s ease-out, color 0.2s ease-out;
      color: #3b3f55;
    }
    #bigStar.done {
      color: #ffd95c;
      text-shadow: 0 0 20px rgba(255,217,92,0.9);
      transform: scale(1.05);
    }

    #centerTextMain {
      font-size: 18px;
      margin-bottom: 4px;
    }
    #centerTextSub {
      font-size: 13px;
      opacity: 0.85;
    }

    /* 下方按鈕列 */
    #toolbar {
      position: fixed;
      bottom: env(safe-area-inset-bottom, 0px);
      left: 0;
      right: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px));
      display: flex;
      justify-content: center;
      z-index: 10;
    }

    #toolbarInner {
      background: rgba(10,10,30,0.9);
      backdrop-filter: blur(10px);
      border-radius: 999px;
      padding: 6px 10px;
      display: flex;
      gap: 6px;
      box-shadow: 0 0 18px rgba(0,0,0,0.7);
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 8px 14px;
      background: #1b2355;
      color: #e5e9ff;
      font-size: 13px;
      font-family: inherit;
      min-width: 72px;
    }
    button.primary { background: #2d5bff; }
    button.danger { background: #ff4b7a; }
    button:active { transform: scale(0.96); }

    /* HUD */
    #hud {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 16px 22px;
      background: white;
      color: #000;
      font-family: ui-monospace, monospace;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(255,255,255,0.9);
      opacity: 0;
      z-index: 20;
      transition: opacity 0.3s ease-out;
      font-size: 18px;
      white-space: pre-line;
      text-align: center;
    }
  </style>
</head>
<body>

<canvas id="bg"></canvas>

<!-- 歷史紀錄 -->
<div id="history">
  <div id="historyLabel">最近 28 天</div>
  <div id="historyBar"></div>
</div>

<!-- 中間大星星 -->
<div id="center">
  <div id="bigStar">★</div>
  <div id="centerTextMain" id="titleText">讀書習慣</div>
  <div id="centerTextSub" id="subText">每天讀滿 2 小時就點亮這顆星</div>
</div>

<!-- HUD -->
<div id="hud"></div>

<!-- 底部按鈕列 -->
<div id="toolbar">
  <div id="toolbarInner">
    <button class="primary" id="btnToggle">今天完成了 ✅</button>
    <button id="btnNote">設定說明</button>
    <button class="danger" id="btnUniverse">⚡</button>
  </div>
</div>

<script>
/* ========= 基本 state ========= */
const bigStar = document.getElementById("bigStar");
const hud     = document.getElementById("hud");
const historyBar = document.getElementById("historyBar");
const btnToggle  = document.getElementById("btnToggle");
const btnNote    = document.getElementById("btnNote");
const btnUniverse= document.getElementById("btnUniverse");

const GOAL_DESC_KEY = "habitStarGoalDesc";
const CAL_KEY       = "habitStarCalendar";

let goalDesc = localStorage[GOAL_DESC_KEY] || "每天讀書至少 2 小時";
document.getElementById("centerTextSub").textContent = goalDesc;

function todayKey() {
  return new Date().toISOString().slice(0,10); // YYYY-MM-DD
}

function loadCalendar() {
  try {
    return JSON.parse(localStorage[CAL_KEY] || "{}");
  } catch(e) {
    return {};
  }
}

function saveCalendar(cal) {
  localStorage[CAL_KEY] = JSON.stringify(cal);
}

let calendar = loadCalendar();
let doneToday = !!calendar[todayKey()];

/* ========= 更新星星 & 按鈕文字 ========= */
function updateStarUI() {
  if (doneToday) {
    bigStar.classList.add("done");
    btnToggle.textContent = "取消今天 ❌";
  } else {
    bigStar.classList.remove("done");
    btnToggle.textContent = "今天完成了 ✅";
  }
}

/* ========= HUD ========= */
function showHUD(msg) {
  hud.textContent = msg;
  hud.style.opacity = 1;
  setTimeout(()=>hud.style.opacity = 0, 900);
}

/* ========= 歷史 28 天小格 ========= */
function renderHistory() {
  historyBar.innerHTML = "";
  const now = new Date();

  for (let i = 27; i >= 0; i--) {
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const key = d.toISOString().slice(0,10);

    const box = document.createElement("div");
    box.className = "historyDay";
    if (calendar[key]) {
      box.classList.add("active");
      box.textContent = "★";
    } else {
      box.textContent = "";
    }
    historyBar.appendChild(box);
  }
}

/* ========= 按鈕事件 ========= */

// 點大星星視同切換
bigStar.addEventListener("click", () => {
  toggleToday();
});

// 今天完成 / 取消
btnToggle.addEventListener("click", () => {
  toggleToday();
});

function toggleToday() {
  doneToday = !doneToday;
  if (doneToday) {
    calendar[todayKey()] = true;
    showHUD("⭐ 已點亮\n今天有讀書");
  } else {
    delete calendar[todayKey()];
    showHUD("已取消今天紀錄");
  }
  saveCalendar(calendar);
  updateStarUI();
  renderHistory();
}

// 說明 / 修改目標描述
btnNote.addEventListener("click", () => {
  const text = prompt(
    "你想用這顆星追蹤什麼習慣？",
    goalDesc
  );
  if (text) {
    goalDesc = text;
    localStorage[GOAL_DESC_KEY] = text;
    document.getElementById("centerTextSub").textContent = goalDesc;
  }
});

// ⚡ 重生宇宙（背景）
btnUniverse.addEventListener("click", () => {
  randomGrid();
  showHUD("⚡ 新宇宙");
});

/* ========= Conway 背景 ========= */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let cols, rows, grid;
const cellSize = 7;

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
  cols = Math.floor(innerWidth / cellSize);
  rows = Math.floor(innerHeight / cellSize);
  randomGrid();
}
window.addEventListener("resize", resize);
resize();

function randomGrid() {
  grid = Array.from({length: rows}, () =>
    Array.from({length: cols}, () => Math.random() < 0.12 ? 1 : 0)
  );
}

function nextGen() {
  let ng = grid.map(r => [...r]);
  for (let y=0;y<rows;y++){
    for (let x=0;x<cols;x++){
      let n=0;
      for (let dy=-1;dy<=1;dy++)
        for (let dx=-1;dx<=1;dx++)
          if(dx||dy) n+=grid[(y+dy+rows)%rows][(x+dx+cols)%cols];
      ng[y][x]=(n===3||n===2&&grid[y][x])?1:0;
    }
  }
  grid = ng;
}

function draw() {
  ctx.fillStyle = "#05060f";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = "#4fa3ff2a";
  for (let y=0;y<rows;y++){
    for (let x=0;x<cols;x++){
      if(grid[y][x]) ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
    }
  }
}

function loop() {
  nextGen();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* ========= 初始化 ========= */
updateStarUI();
renderHistory();
</script>
</body>
</html>
