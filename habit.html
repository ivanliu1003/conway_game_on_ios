<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>HabitOS ‚Äî Star Tracker</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="HabitOS">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: #07080f;
      color: #e5e9ff;
    }

    canvas {
      position: fixed;
      inset: 0;
      z-index: 0;
    }

    /* Ë™ûÈåÑÂçÄ */
    #quoteBox {
      position: fixed;
      top: calc(env(safe-area-inset-top, 10px) + 8px);
      left: 12px;
      right: 12px;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(10, 10, 30, 0.86);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(120,140,255,0.6);
      font-size: 13px;
      z-index: 5;
      text-align: center;
    }
    #quoteText {
      opacity: 0.9;
    }

    /* ÁøíÊÖ£ÂàóË°® */
    #habitList {
      position: fixed;
      top: calc(env(safe-area-inset-top, 10px) + 60px);
      bottom: calc(env(safe-area-inset-bottom, 0px) + 70px);
      left: 0;
      right: 0;
      padding: 8px 10px 8px 10px;
      overflow-y: auto;
      z-index: 5;
    }

    .habitCard {
      background: rgba(10, 12, 30, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(80, 90, 150, 0.7);
      padding: 10px 12px;
      margin-bottom: 8px;
      box-shadow: 0 0 14px rgba(0,0,0,0.4);
    }

    .habitHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .habitName {
      font-size: 15px;
      font-weight: 600;
    }

    .habitStreak {
      font-size: 11px;
      color: #ffc96a;
    }

    .habitDesc {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 6px;
    }

    .habitMainRow {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .bigStar {
      font-size: 32px;
      cursor: pointer;
      transition: transform 0.2s ease-out, text-shadow 0.2s, color 0.2s;
      color: #3b3f55;
    }

    .bigStar.done {
      color: #ffd95c;
      text-shadow: 0 0 16px rgba(255,217,92,0.9);
      transform: scale(1.05);
    }

    .toggleBtn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      background: #2d5bff;
      color: #e5e9ff;
      font-size: 12px;
      font-family: inherit;
      min-width: 90px;
    }

    .editBtn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      background: #202546;
      color: #b9c0ff;
      font-size: 10px;
      font-family: inherit;
    }

    .toggleBtn:active,
    .editBtn:active {
      transform: scale(0.96);
    }

    .miniHistory {
      display: flex;
      gap: 3px;
      margin-top: 2px;
    }
    .miniDot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      background: #1b2035;
    }
    .miniDot.done {
      background: #4fa3ff;
      box-shadow: 0 0 5px #4fa3ff;
    }

    /* Â∫ïÈÉ®Â∑•ÂÖ∑Âàó */
    #toolbar {
      position: fixed;
      bottom: env(safe-area-inset-bottom, 0px);
      left: 0;
      right: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px));
      display: flex;
      justify-content: center;
      z-index: 10;
    }

    #toolbarInner {
      background: rgba(10,10,30,0.9);
      backdrop-filter: blur(10px);
      border-radius: 999px;
      padding: 6px 10px;
      display: flex;
      gap: 6px;
      box-shadow: 0 0 18px rgba(0,0,0,0.7);
    }

    .toolBtn {
      border: none;
      border-radius: 999px;
      padding: 7px 12px;
      background: #1b2355;
      color: #e5e9ff;
      font-size: 12px;
      font-family: inherit;
      min-width: 70px;
    }
    .toolBtn.primary { background: #2d5bff; }
    .toolBtn.danger { background: #ff4b7a; }
    .toolBtn:active { transform: scale(0.96); }

    /* HUD */
    #hud {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 14px 20px;
      background: white;
      color: #000;
      font-family: ui-monospace, monospace;
      border-radius: 10px;
      box-shadow: 0 0 18px rgba(255,255,255,0.9);
      opacity: 0;
      z-index: 20;
      transition: opacity 0.25s ease-out;
      font-size: 16px;
      white-space: pre-line;
      text-align: center;
    }
  </style>
</head>
<body>

<canvas id="bg"></canvas>

<!-- ÂãµÂøóË™ûÈåÑ -->
<div id="quoteBox">
  <div id="quoteText"></div>
</div>

<!-- Â§öÁøíÊÖ£ÂàóË°® -->
<div id="habitList"></div>

<!-- HUD -->
<div id="hud"></div>

<!-- Â∑•ÂÖ∑Âàó -->
<div id="toolbar">
  <div id="toolbarInner">
    <button class="toolBtn primary" id="btnAddHabit">Êñ∞Â¢ûÁøíÊÖ£</button>
    <button class="toolBtn" id="btnNewQuote">Êèõ‰∏ÄÂè•</button>
    <button class="toolBtn danger" id="btnUniverse">‚ö°</button>
  </div>
</div>

<script>
/* ========= Ë™ûÈåÑ ========= */
const QUOTES = [
  "‰ªäÂ§©ÂÅöÁöÑÊØè‰∏ÄÈ°åÔºåÈÉΩÊòØÂú®Âπ´Êú™‰æÜÁöÑËá™Â∑±ÈÇÑÂÇµ„ÄÇ",
  "‰∏çÊòØ‰Ω†‰∏çÂ§†ËÅ∞ÊòéÔºåÊòØ‰Ω†ÈÇÑ‰∏çÂ§†Á©©ÂÆöÂú∞Âùê‰∏ã‰æÜ„ÄÇ",
  "ÂÖàÊ±ÇÊúâÔºåÂÜçÊ±ÇÂ•ΩÔºõÂÖàÈñãÂßãÔºåÂÜçÂÆåÁæé„ÄÇ",
  "‰Ω†ÁèæÂú®ÂÅ∑ÁöÑÊá∂ÔºåÊú™‰æÜÈÉΩÊúÉÁî®Êõ¥Á°¨ÁöÑÊñπÂºèÈÇÑÂõû‰æÜ„ÄÇ",
  "Â∞àÊ≥®‰∏ÄÂ∞èÊôÇÔºåÊØîÂàÜÂøÉ‰∏âÂ∞èÊôÇÊúâÁî®Â§ö‰∫Ü„ÄÇ",
  "Âà•Ë∑üÂà•‰∫∫ÊØîÔºåÂÖàÊääÊò®Â§©ÁöÑËá™Â∑±ÊâìÁàÜÂÜçË™™„ÄÇ",
  "Â¶ÇÊûú‰∏ÄÂÆöË¶ÅÁÜ¨Â§úÔºåÈÇ£Â∞±Á¢∫‰øùÂÆÉÊòØÂÄºÂæóÁöÑ„ÄÇ",
  "Â≠∏Áøí‰∏çÊòØÁÇ∫‰∫ÜËÄÉË©¶ÔºåÊòØÁÇ∫‰∫ÜËÆì‰Ω†‰ª•ÂæåÂèØ‰ª•ÈÅ∏Êìá„ÄÇ",
  "‰Ω†ÁèæÂú®ÂïÉÁöÑÊØè‰∏ÄÈ†ÅÔºåÈÉΩÊòØÂπ´‰Ω†ÊâìÈñã‰∏ÄÊâáÈñÄ„ÄÇ",
  "Áï∂‰Ω†‰∏çÊÉ≥ËÆÄÊõ∏ÊôÇÔºåÂâõÂ•ΩÂ∞±ÊòØÊúÄÈúÄË¶ÅËÆÄÊõ∏ÁöÑÊôÇÂÄô„ÄÇ"
];

function pickQuote() {
  const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
  document.getElementById("quoteText").textContent = q;
}

/* ========= ÁøíÊÖ£Ë≥áÊñô ========= */
const HABITS_KEY = "starHabits_multi";
const CAL_KEY    = "starHabits_calendar";

function todayKey() {
  return new Date().toISOString().slice(0,10);
}

function loadHabits() {
  try {
    const raw = localStorage[HABITS_KEY];
    if (!raw) {
      const defaults = [
        {id:"h1", name:"ËÆÄÊõ∏ 2 Â∞èÊôÇ", desc:"Âè™Ë¶Å‰ªäÂ§©ÊúâÂ•ΩÂ•ΩÂùê‰∏ã‰æÜËÆÄÊõ∏ÔºåÂ∞±Èªû‰∫ÆÈÄôÈ°ÜÊòü"},
        {id:"h2", name:"ÈÅãÂãï", desc:"Âì™ÊÄïÂè™ÊòØ 10 ÂàÜÈêò‰πüÁÆó"},
        {id:"h3", name:"Êó©Áù°", desc:"Ë∂ÖÈÅé 12 ÈªûÂ∞±‰∏çÁÆó"}
      ];
      localStorage[HABITS_KEY] = JSON.stringify(defaults);
      return defaults;
    }
    return JSON.parse(raw);
  } catch(e) {
    return [];
  }
}

function saveHabits(list) {
  localStorage[HABITS_KEY] = JSON.stringify(list);
}

function loadCalendar() {
  try {
    return JSON.parse(localStorage[CAL_KEY] || "{}");
  } catch(e) {
    return {};
  }
}

function saveCalendar(cal) {
  localStorage[CAL_KEY] = JSON.stringify(cal);
}

let habits   = loadHabits();
let calendar = loadCalendar();

/* ========= Â∑•ÂÖ∑ ========= */
function isDone(habitId, dateKey) {
  const byHabit = calendar[habitId] || {};
  return !!byHabit[dateKey];
}

function setDone(habitId, dateKey, value) {
  if (!calendar[habitId]) calendar[habitId] = {};
  if (value) calendar[habitId][dateKey] = true;
  else delete calendar[habitId][dateKey];
  saveCalendar(calendar);
}

/* ÈÄ£Á∫åÂ§©Êï∏ streak */
function getStreak(habitId) {
  const byHabit = calendar[habitId] || {};
  let streak = 0;
  const now = new Date();
  for (let i = 0; ; i++) {
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const key = d.toISOString().slice(0,10);
    if (byHabit[key]) streak++;
    else break;
  }
  return streak;
}

/* ========= HUD ========= */
const hud = document.getElementById("hud");
function showHUD(msg) {
  hud.textContent = msg;
  hud.style.opacity = 1;
  setTimeout(()=>hud.style.opacity = 0, 900);
}

/* ========= Ê∏≤ÊüìÁøíÊÖ£Âç°Áâá ========= */
const habitListDiv = document.getElementById("habitList");

function renderHabits() {
  habitListDiv.innerHTML = "";

  const today = todayKey();

  habits.forEach(habit => {
    const card = document.createElement("div");
    card.className = "habitCard";
    card.dataset.id = habit.id;

    // header
    const header = document.createElement("div");
    header.className = "habitHeader";

    const nameDiv = document.createElement("div");
    nameDiv.className = "habitName";
    nameDiv.textContent = habit.name;

    const rightHeader = document.createElement("div");

    const streakDiv = document.createElement("div");
    streakDiv.className = "habitStreak";
    const s = getStreak(habit.id);
    streakDiv.textContent = s > 0 ? `üî• Â∑≤ÈÄ£Á∫å ${s} Â§©` : "ÈÇÑÊ≤íÈñãÂßã";

    const editBtn = document.createElement("button");
    editBtn.className = "editBtn";
    editBtn.textContent = "‚ãØ";
    editBtn.title = "ÈáçÊñ∞ÂëΩÂêç / Âà™Èô§";

    rightHeader.appendChild(streakDiv);
    rightHeader.appendChild(editBtn);

    header.appendChild(nameDiv);
    header.appendChild(rightHeader);
    card.appendChild(header);

    // desc
    const descDiv = document.createElement("div");
    descDiv.className = "habitDesc";
    descDiv.textContent = habit.desc || "";
    card.appendChild(descDiv);

    // main row: star + button
    const mainRow = document.createElement("div");
    mainRow.className = "habitMainRow";

    const starSpan = document.createElement("span");
    starSpan.className = "bigStar";
    starSpan.textContent = "‚òÖ";
    if (isDone(habit.id, today)) starSpan.classList.add("done");

    const toggleBtn = document.createElement("button");
    toggleBtn.className = "toggleBtn";
    toggleBtn.textContent = isDone(habit.id, today)
      ? "ÂèñÊ∂à‰ªäÂ§©"
      : "‰ªäÂ§©ÂÆåÊàê‰∫Ü";

    mainRow.appendChild(starSpan);
    mainRow.appendChild(toggleBtn);
    card.appendChild(mainRow);

    // mini history: ÊúÄËøë 7 Â§©
    const mini = document.createElement("div");
    mini.className = "miniHistory";
    const now = new Date();
    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      const key = d.toISOString().slice(0,10);

      const dot = document.createElement("div");
      dot.className = "miniDot";
      if (isDone(habit.id, key)) dot.classList.add("done");
      mini.appendChild(dot);
    }
    card.appendChild(mini);

    habitListDiv.appendChild(card);
  });
}

/* ========= ‰∫ã‰ª∂ÔºöÂç°ÁâáÂÖßÈªûÊìä ========= */
habitListDiv.addEventListener("click", (e) => {
  const card = e.target.closest(".habitCard");
  if (!card) return;
  const id = card.dataset.id;
  const today = todayKey();

  // ÈªûÊòüÊòü or ÊåâÈàï ‚Üí ÂàáÊèõÂÆåÊàêÁãÄÊÖã
  if (e.target.classList.contains("bigStar") ||
      e.target.classList.contains("toggleBtn")) {

    const done = !isDone(id, today);
    setDone(id, today, done);
    renderHabits();
    pickQuote();   // ÂàáÊèõÊôÇÈ†Ü‰æøÊèõ‰∏ÄÂè•Ë©±
    showHUD(done ? "‚≠ê ‰ªäÂ§©ÂÆåÊàêÔºÅ" : "Â∑≤ÂèñÊ∂à‰ªäÂ§©Á¥ÄÈåÑ");
    return;
  }

  // Á∑®ËºØÁøíÊÖ£
  if (e.target.classList.contains("editBtn")) {
    const habit = habits.find(h => h.id === id);
    if (!habit) return;
    const action = prompt(
      "Ëº∏ÂÖ•Êñ∞ÂêçÁ®±ÔºåÊàñËº∏ÂÖ• DELETE Âà™Èô§Ê≠§ÁøíÊÖ£Ôºö",
      habit.name
    );
    if (action === null) return;
    if (action === "DELETE") {
      if (confirm("Á¢∫ÂÆöË¶ÅÂà™Èô§ÈÄôÂÄãÁøíÊÖ£ÂóéÔºüÊ≠∑Âè≤Á¥ÄÈåÑ‰πüÊúÉ‰∏ÄËµ∑Âà™Êéâ„ÄÇ")) {
        habits = habits.filter(h => h.id !== id);
        delete calendar[id];
        saveHabits(habits);
        saveCalendar(calendar);
        renderHabits();
        showHUD("Â∑≤Âà™Èô§ÁøíÊÖ£");
      }
    } else {
      habit.name = action;
      const newDesc = prompt("ÂèØÈÅ∏ÔºöÊõ¥Êñ∞ÊèèËø∞ÔºàÁïôÁ©∫Â∞±‰∏çÊîπÔºâ", habit.desc || "");
      if (newDesc !== null && newDesc !== "") {
        habit.desc = newDesc;
      }
      saveHabits(habits);
      renderHabits();
      showHUD("Â∑≤Êõ¥Êñ∞ÁøíÊÖ£");
    }
  }
});

/* ========= Êñ∞Â¢ûÁøíÊÖ£ ========= */
document.getElementById("btnAddHabit").addEventListener("click", () => {
  const name = prompt("ÁøíÊÖ£ÂêçÁ®±Ôºà‰æãÂ¶ÇÔºöÊØèÂ§©ÂØ´ 2 È°åÊï∏Â≠∏Ôºâ");
  if (!name) return;
  const desc = prompt("Á∞°Áü≠ÊèèËø∞ÔºàÂèØÁïôÁ©∫Ôºâ", "‰Ω†ÊÉ≥Ë¶ÅÊ±ÇËá™Â∑±ÁöÑÂÖ∑È´îÊ®ôÊ∫ñÔºå‰æãÂ¶ÇËÆÄÊõ∏Â§ö‰πÖÁÆóÂÆåÊàê");
  const id = "h_" + Date.now();
  habits.push({id, name, desc: desc || ""});
  saveHabits(habits);
  renderHabits();
  showHUD("Â∑≤Êñ∞Â¢ûÁøíÊÖ£");
});

/* ========= Êèõ‰∏ÄÂè•Ë™ûÈåÑ ========= */
document.getElementById("btnNewQuote").addEventListener("click", () => {
  pickQuote();
});

/* ========= Conway ËÉåÊôØ ========= */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let cols, rows, grid;
const cellSize = 7;

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
  cols = Math.floor(innerWidth / cellSize);
  rows = Math.floor(innerHeight / cellSize);
  randomGrid();
}
window.addEventListener("resize", resize);
resize();

function randomGrid() {
  grid = Array.from({length: rows}, () =>
    Array.from({length: cols}, () => Math.random() < 0.12 ? 1 : 0)
  );
}

function nextGen() {
  let ng = grid.map(r => [...r]);
  for (let y=0;y<rows;y++){
    for (let x=0;x<cols;x++){
      let n=0;
      for (let dy=-1;dy<=1;dy++)
        for (let dx=-1;dx<=1;dx++)
          if(dx||dy) n+=grid[(y+dy+rows)%rows][(x+dx+cols)%cols];
      ng[y][x]=(n===3||n===2&&grid[y][x])?1:0;
    }
  }
  grid = ng;
}

function draw() {
  ctx.fillStyle = "#05060f";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = "#4fa3ff2a";
  for (let y=0;y<rows;y++){
    for (let x=0;x<cols;x++){
      if(grid[y][x]) ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
    }
  }
}

function loop() {
  nextGen();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* ========= ‚ö° ÈáçÁîüÂÆáÂÆô ========= */
document.getElementById("btnUniverse").addEventListener("click", () => {
  randomGrid();
  showHUD("‚ö° Êñ∞ÂÆáÂÆô");
});

/* ========= ÂàùÂßãÂåñ ========= */
pickQuote();
renderHabits();
</script>
</body>
</html>
