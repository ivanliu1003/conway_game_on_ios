<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>HabitOS â€” Star Tracker</title>

  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="HabitOS">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      overflow: hidden;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: #07080f;
      color: #e5e9ff;
    }

    canvas {
      position: fixed;
      inset: 0;
      z-index: 0;
    }

    /* èªéŒ„å€ */
    #quoteBox {
      position: fixed;
      top: calc(env(safe-area-inset-top, 10px) + 8px);
      left: 12px;
      right: 12px;
      padding: 8px 12px;
      border-radius: 10px;
      background: rgba(10, 10, 30, 0.86);
      backdrop-filter: blur(12px);
      border: 1px solid rgba(120,140,255,0.6);
      font-size: 13px;
      z-index: 5;
      text-align: center;
    }
    #quoteText {
      opacity: 0.9;
    }

    /* ç¿’æ…£åˆ—è¡¨ */
    #habitList {
      position: fixed;
      top: calc(env(safe-area-inset-top, 10px) + 60px);
      bottom: calc(env(safe-area-inset-bottom, 0px) + 70px);
      left: 0;
      right: 0;
      padding: 8px 10px 8px 10px;
      overflow-y: auto;
      z-index: 5;
    }

    .habitCard {
      background: rgba(10, 12, 30, 0.9);
      border-radius: 12px;
      border: 1px solid rgba(80, 90, 150, 0.7);
      padding: 10px 12px;
      margin-bottom: 8px;
      box-shadow: 0 0 14px rgba(0,0,0,0.4);
    }

    .habitHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }

    .habitName {
      font-size: 15px;
      font-weight: 600;
    }

    .habitStreak {
      font-size: 11px;
      color: #ffc96a;
    }

    .habitDesc {
      font-size: 12px;
      opacity: 0.8;
      margin-bottom: 6px;
    }

    .habitMainRow {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 4px;
    }

    .bigStar {
      font-size: 32px;
      cursor: pointer;
      transition: transform 0.2s ease-out, text-shadow 0.2s, color 0.2s;
      color: #3b3f55;
    }

    .bigStar.done {
      color: #ffd95c;
      text-shadow: 0 0 16px rgba(255,217,92,0.9);
      transform: scale(1.05);
    }

    .toggleBtn {
      border: none;
      border-radius: 999px;
      padding: 6px 12px;
      background: #2d5bff;
      color: #e5e9ff;
      font-size: 12px;
      font-family: inherit;
      min-width: 90px;
    }

    .editBtn {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      background: #202546;
      color: #b9c0ff;
      font-size: 10px;
      font-family: inherit;
    }

    .toggleBtn:active,
    .editBtn:active {
      transform: scale(0.96);
    }

    .miniHistory {
      display: flex;
      gap: 3px;
      margin-top: 2px;
    }
    .miniDot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      background: #1b2035;
    }
    .miniDot.done {
      background: #4fa3ff;
      box-shadow: 0 0 5px #4fa3ff;
    }

    /* åº•éƒ¨å·¥å…·åˆ— */
    #toolbar {
      position: fixed;
      bottom: env(safe-area-inset-bottom, 0px);
      left: 0;
      right: 0;
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px));
      display: flex;
      justify-content: center;
      z-index: 10;
    }

    #toolbarInner {
      background: rgba(10,10,30,0.9);
      backdrop-filter: blur(10px);
      border-radius: 999px;
      padding: 6px 10px;
      display: flex;
      gap: 6px;
      box-shadow: 0 0 18px rgba(0,0,0,0.7);
    }

    .toolBtn {
      border: none;
      border-radius: 999px;
      padding: 7px 10px;
      background: #1b2355;
      color: #e5e9ff;
      font-size: 12px;
      font-family: inherit;
      min-width: 64px;
    }
    .toolBtn.primary { background: #2d5bff; }
    .toolBtn.danger  { background: #ff4b7a; }
    .toolBtn:active { transform: scale(0.96); }

    /* HUD */
    #hud {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      padding: 14px 20px;
      background: white;
      color: #000;
      font-family: ui-monospace, monospace;
      border-radius: 10px;
      box-shadow: 0 0 18px rgba(255,255,255,0.9);
      opacity: 0;
      z-index: 40;
      transition: opacity 0.25s ease-out;
      font-size: 16px;
      white-space: pre-line;
      text-align: center;
    }

    /* ç¬¬ä¸€é¡†æ˜Ÿçš„çˆ†æ“Šå‹•ç•« */
    #firstStarFX {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.2);
      font-size: 80px;
      opacity: 0;
      z-index: 45;
      pointer-events: none;
      text-shadow: 0 0 30px rgba(255, 217, 92, 0.9);
    }
    #firstStarFX.show {
      animation: starPop 0.8s ease-out forwards;
    }
    @keyframes starPop {
      0%   { opacity: 0;   transform: translate(-50%, -50%) scale(0.2); }
      30%  { opacity: 1;   transform: translate(-50%, -50%) scale(1.2); }
      60%  { opacity: 1;   transform: translate(-50%, -50%) scale(1.0); }
      100% { opacity: 0;   transform: translate(-50%, -50%) scale(0.6); }
    }

    /* å…¨å¹´ç†±åŠ›åœ–é¢æ¿ */
    #yearPanel, #startPanel {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(12px);
      display: none;
      z-index: 30;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #yearBox, #startBox {
      width: 100%;
      max-width: 440px;
      max-height: 90vh;
      background: #0b0d1a;
      border-radius: 14px;
      border: 1px solid #444c88;
      padding: 12px;
      box-shadow: 0 0 24px rgba(0,0,0,0.8);
      display: flex;
      flex-direction: column;
    }

    #yearTitle, #startTitle {
      font-size: 17px;
      margin-bottom: 4px;
    }
    #yearHint, #startHint {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    #yearGrid {
      flex: 1;
      overflow-y: auto;
      padding-right: 4px;
      margin-bottom: 8px;
      font-size: 11px;
    }

    .yearMonth {
      margin-bottom: 8px;
    }
    .yearMonthTitle {
      margin-bottom: 3px;
      opacity: 0.85;
    }
    .yearDays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 2px;
    }
    .yearDay {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      background: #15182a;
    }
    .heat0 { background: #15182a; }
    .heat1 { background: #244a7f; }
    .heat2 { background: #3d7bff; }
    .heat3 { background: #6bb4ff; }

    #yearButtons, #startButtons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      font-size: 13px;
    }
    #yearButtons button,
    #startButtons button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-family: inherit;
      font-size: 13px;
    }

    /* å•Ÿå‹•å„€å¼å…§å®¹ */
    #startBody {
      font-size: 13px;
      opacity: 0.9;
      margin-bottom: 8px;
      white-space: pre-line;
    }
    #startTimer {
      font-family: ui-monospace, monospace;
      font-size: 24px;
      margin-bottom: 8px;
      text-align: center;
    }

  </style>
</head>
<body>

<canvas id="bg"></canvas>

<!-- å‹µå¿—èªéŒ„ -->
<div id="quoteBox">
  <div id="quoteText"></div>
</div>

<!-- å¤šç¿’æ…£åˆ—è¡¨ -->
<div id="habitList"></div>

<!-- HUD -->
<div id="hud"></div>
<div id="firstStarFX">â­</div>

<!-- å·¥å…·åˆ— -->
<div id="toolbar">
  <div id="toolbarInner">
    <button class="toolBtn primary" id="btnAddHabit">æ–°å¢</button>
    <button class="toolBtn" id="btnStartRitual">å•Ÿå‹• 2 åˆ†é˜</button>
    <button class="toolBtn" id="btnYearView">Year</button>
    <button class="toolBtn" id="btnNewQuote">æ›ä¸€å¥</button>
    <button class="toolBtn danger" id="btnUniverse">âš¡</button>
  </div>
</div>

<!-- å¹´åº¦ç†±åŠ›åœ–é¢æ¿ -->
<div id="yearPanel">
  <div id="yearBox">
    <div id="yearTitle">å¹´åº¦ç†±åŠ›åœ–</div>
    <div id="yearHint">é¡è‰²è¶Šäº®ä»£è¡¨é‚£å¤©å®Œæˆçš„ç¿’æ…£è¶Šå¤šã€‚</div>
    <div id="yearGrid"></div>
    <div id="yearButtons">
      <button id="btnCloseYear">é—œé–‰</button>
    </div>
  </div>
</div>

<!-- å•Ÿå‹•å„€å¼é¢æ¿ -->
<div id="startPanel">
  <div id="startBox">
    <div id="startTitle">å•Ÿå‹•å„€å¼ Â· 2 åˆ†é˜</div>
    <div id="startHint">ç…§é€™å€‹åšå®Œå°±å¯ä»¥å»é»äº®ä¸€é¡†æ˜Ÿã€‚</div>
    <div id="startBody">
1. åä¸‹ï¼Œä¸ç”¨æ•´ç†æ¡Œå­
2. æŠŠæ›¸æˆ–ç­†è¨˜æœ¬æ”¾åœ¨æ¡Œä¸Š
3. å‘Šè¨´è‡ªå·±ï¼šåªå…ˆè®€ 2 åˆ†é˜
4. ç¿»é–‹ä»»æ„ä¸€é ï¼Œçœ‹è‘—å­— 10 ç§’
5. ç„¶å¾Œé–‹å§‹å¯« / è®€

é€™ 2 åˆ†é˜åªæ˜¯ä¸€å€‹ã€Œå•Ÿå‹•ã€ï¼Œä¸æ˜¯åœ¨æ¯”èª°æœ€æœƒè®€ã€‚
    </div>
    <div id="startTimer">02:00</div>
    <div id="startButtons">
      <button id="btnCancelStart">å–æ¶ˆ</button>
      <button id="btnBeginStart" style="background:#2d5bff; color:white;">é–‹å§‹è¨ˆæ™‚</button>
    </div>
  </div>
</div>

<script>
/* ========= èªéŒ„ ========= */
const QUOTES = [
  "ä»Šå¤©åšçš„æ¯ä¸€é¡Œï¼Œéƒ½æ˜¯åœ¨å¹«æœªä¾†çš„è‡ªå·±é‚„å‚µã€‚",
  "ä¸æ˜¯ä½ ä¸å¤ è°æ˜ï¼Œæ˜¯ä½ é‚„ä¸å¤ ç©©å®šåœ°åä¸‹ä¾†ã€‚",
  "å…ˆæ±‚æœ‰ï¼Œå†æ±‚å¥½ï¼›å…ˆé–‹å§‹ï¼Œå†å®Œç¾ã€‚",
  "ä½ ç¾åœ¨å·çš„æ‡¶ï¼Œæœªä¾†éƒ½æœƒç”¨æ›´ç¡¬çš„æ–¹å¼é‚„å›ä¾†ã€‚",
  "å°ˆæ³¨ä¸€å°æ™‚ï¼Œæ¯”åˆ†å¿ƒä¸‰å°æ™‚æœ‰ç”¨å¤šäº†ã€‚",
  "åˆ¥è·Ÿåˆ¥äººæ¯”ï¼Œå…ˆæŠŠæ˜¨å¤©çš„è‡ªå·±æ‰“çˆ†å†èªªã€‚",
  "å¦‚æœä¸€å®šè¦ç†¬å¤œï¼Œé‚£å°±ç¢ºä¿å®ƒæ˜¯å€¼å¾—çš„ã€‚",
  "å­¸ç¿’ä¸æ˜¯ç‚ºäº†è€ƒè©¦ï¼Œæ˜¯ç‚ºäº†è®“ä½ ä»¥å¾Œå¯ä»¥é¸æ“‡ã€‚",
  "ä½ ç¾åœ¨å•ƒçš„æ¯ä¸€é ï¼Œéƒ½åœ¨å¹«ä½ æ‰“é–‹ä¸€æ‰‡é–€ã€‚",
  "ç•¶ä½ ä¸æƒ³è®€æ›¸æ™‚ï¼Œå‰›å¥½å°±æ˜¯æœ€éœ€è¦è®€æ›¸çš„æ™‚å€™ã€‚",
  "ä½ ä¸æ˜¯ä¸è¡Œï¼Œä½ åªæ˜¯é‚„æ²’é–‹å§‹åšã€‚",
  "é–‹å§‹æ°¸é æ˜¯æœ€é›£çš„é‚£ä¸€æ­¥ï¼Œä½†ä½ å·²ç¶“æº–å‚™å¥½äº†ã€‚",
  "æ‹–å»¶åªæœƒè®“ä½ æ›´ç—›è‹¦ï¼Œä¸æœƒè®“äº‹æƒ…è®Šç°¡å–®ã€‚",
  "ä½ ç¾åœ¨çš„ç´¯ï¼Œæœªä¾†æœƒè®Šæˆä½ çš„åº•æ°£ã€‚",
  "æ²’æœ‰ç™½å—çš„è‹¦ï¼Œä¹Ÿæ²’æœ‰ç™½è®€çš„æ›¸ã€‚",
  "ä½ ä¸æ˜¯åœ¨è®€æ›¸ï¼Œä½ åœ¨ç‚ºæœªä¾†çš„è‡ªå·±é‹ªè·¯ã€‚",
  "ä»Šå¤©ç¿»é–‹çš„ä¸åªæ˜¯æ›¸ï¼Œæ˜¯å‘½é‹ã€‚",
  "è¡Œå‹•æœ¬èº«æœƒç”Ÿå‡ºå‹•åŠ›ï¼Œä¸æ˜¯åéä¾†ã€‚",
  "ä½ ä¸éœ€è¦å®Œç¾ï¼Œä½ åªéœ€è¦æ¯”æ˜¨å¤©å¤šä¸€é»ã€‚",
  "ä½ ç¾åœ¨åœ¨æ­éšæ¢¯ï¼Œæœªä¾†æ‰è¸©å¾—ç©©ã€‚"
];

function pickQuote() {
  const q = QUOTES[Math.floor(Math.random() * QUOTES.length)];
  document.getElementById("quoteText").textContent = q;
}

/* ========= ç¿’æ…£è³‡æ–™ ========= */
const HABITS_KEY = "starHabits_multi";
const CAL_KEY    = "starHabits_calendar";

function todayKey() {
  return new Date().toISOString().slice(0,10);
}

function loadHabits() {
  try {
    const raw = localStorage[HABITS_KEY];
    if (!raw) {
      const defaults = [
        {id:"h1", name:"è®€æ›¸ 2 å°æ™‚", desc:"åªè¦ä»Šå¤©æœ‰å¥½å¥½åä¸‹ä¾†è®€æ›¸ï¼Œå°±é»äº®é€™é¡†æ˜Ÿ"},
        {id:"h2", name:"é‹å‹•",       desc:"å“ªæ€•åªæ˜¯ 10 åˆ†é˜ä¹Ÿç®—"},
        {id:"h3", name:"æ—©ç¡",       desc:"è¶…é 12 é»å°±ä¸ç®—"}
      ];
      localStorage[HABITS_KEY] = JSON.stringify(defaults);
      return defaults;
    }
    return JSON.parse(raw);
  } catch(e) {
    return [];
  }
}

function saveHabits(list) {
  localStorage[HABITS_KEY] = JSON.stringify(list);
}

function loadCalendar() {
  try {
    return JSON.parse(localStorage[CAL_KEY] || "{}");
  } catch(e) {
    return {};
  }
}

function saveCalendar(cal) {
  localStorage[CAL_KEY] = JSON.stringify(cal);
}

let habits   = loadHabits();
let calendar = loadCalendar();

/* ========= å·¥å…· ========= */
function isDone(habitId, dateKey) {
  const byHabit = calendar[habitId] || {};
  return !!byHabit[dateKey];
}

function setDone(habitId, dateKey, value) {
  if (!calendar[habitId]) calendar[habitId] = {};
  if (value) calendar[habitId][dateKey] = true;
  else delete calendar[habitId][dateKey];
  saveCalendar(calendar);
}

/* ç•¶å¤©å®Œæˆå¹¾é¡†æ˜Ÿ */
function countDoneForDate(dateKey) {
  let c = 0;
  habits.forEach(h => {
    const byHabit = calendar[h.id] || {};
    if (byHabit[dateKey]) c++;
  });
  return c;
}

/* é€£çºŒå¤©æ•¸ streak */
function getStreak(habitId) {
  const byHabit = calendar[habitId] || {};
  let streak = 0;
  const now = new Date();
  for (let i = 0; ; i++) {
    const d = new Date(now);
    d.setDate(now.getDate() - i);
    const key = d.toISOString().slice(0,10);
    if (byHabit[key]) streak++;
    else break;
  }
  return streak;
}

/* ========= HUD ========= */
const hud = document.getElementById("hud");
function showHUD(msg) {
  hud.textContent = msg;
  hud.style.opacity = 1;
  setTimeout(()=>hud.style.opacity = 0, 900);
}

/* ç¬¬ä¸€é¡†æ˜Ÿå‹•ç•« */
const firstStarFX = document.getElementById("firstStarFX");
function playFirstStarFX() {
  firstStarFX.classList.remove("show");
  void firstStarFX.offsetWidth; // reflow
  firstStarFX.classList.add("show");
}

/* ========= æ¸²æŸ“ç¿’æ…£å¡ç‰‡ ========= */
const habitListDiv = document.getElementById("habitList");

function renderHabits() {
  habitListDiv.innerHTML = "";

  const today = todayKey();

  habits.forEach(habit => {
    const card = document.createElement("div");
    card.className = "habitCard";
    card.dataset.id = habit.id;

    // header
    const header = document.createElement("div");
    header.className = "habitHeader";

    const nameDiv = document.createElement("div");
    nameDiv.className = "habitName";
    nameDiv.textContent = habit.name;

    const rightHeader = document.createElement("div");

    const streakDiv = document.createElement("div");
    streakDiv.className = "habitStreak";
    const s = getStreak(habit.id);
    streakDiv.textContent = s > 0 ? `ğŸ”¥ å·²é€£çºŒ ${s} å¤©` : "é‚„æ²’é–‹å§‹";

    const editBtn = document.createElement("button");
    editBtn.className = "editBtn";
    editBtn.textContent = "â‹¯";
    editBtn.title = "é‡æ–°å‘½å / åˆªé™¤";

    rightHeader.appendChild(streakDiv);
    rightHeader.appendChild(editBtn);

    header.appendChild(nameDiv);
    header.appendChild(rightHeader);
    card.appendChild(header);

    // desc
    const descDiv = document.createElement("div");
    descDiv.className = "habitDesc";
    descDiv.textContent = habit.desc || "";
    card.appendChild(descDiv);

    // main row: star + button
    const mainRow = document.createElement("div");
    mainRow.className = "habitMainRow";

    const starSpan = document.createElement("span");
    starSpan.className = "bigStar";
    starSpan.textContent = "â˜…";
    if (isDone(habit.id, today)) starSpan.classList.add("done");

    const toggleBtn = document.createElement("button");
    toggleBtn.className = "toggleBtn";
    toggleBtn.textContent = isDone(habit.id, today)
      ? "å–æ¶ˆä»Šå¤©"
      : "ä»Šå¤©å®Œæˆäº†";

    mainRow.appendChild(starSpan);
    mainRow.appendChild(toggleBtn);
    card.appendChild(mainRow);

    // mini history: æœ€è¿‘ 7 å¤©
    const mini = document.createElement("div");
    mini.className = "miniHistory";
    const now = new Date();
    for (let i = 6; i >= 0; i--) {
      const d = new Date(now);
      d.setDate(now.getDate() - i);
      const key = d.toISOString().slice(0,10);

      const dot = document.createElement("div");
      dot.className = "miniDot";
      if (isDone(habit.id, key)) dot.classList.add("done");
      mini.appendChild(dot);
    }
    card.appendChild(mini);

    habitListDiv.appendChild(card);
  });
}

/* ========= äº‹ä»¶ï¼šå¡ç‰‡å…§é»æ“Š ========= */
habitListDiv.addEventListener("click", (e) => {
  const card = e.target.closest(".habitCard");
  if (!card) return;
  const id = card.dataset.id;
  const today = todayKey();

  // é»æ˜Ÿæ˜Ÿ or æŒ‰éˆ• â†’ åˆ‡æ›å®Œæˆç‹€æ…‹
  if (e.target.classList.contains("bigStar") ||
      e.target.classList.contains("toggleBtn")) {

    const beforeCount = countDoneForDate(today);
    const done = !isDone(id, today);
    setDone(id, today, done);
    const afterCount = countDoneForDate(today);

    renderHabits();
    pickQuote();   // åˆ‡æ›æ™‚é †ä¾¿æ›ä¸€å¥è©±

    if (done) {
      showHUD("â­ ä»Šå¤©å®Œæˆï¼");
      if (beforeCount === 0 && afterCount === 1) {
        // ä»Šæ—¥ç¬¬ä¸€é¡†æ˜Ÿ
        playFirstStarFX();
      }
    } else {
      showHUD("å·²å–æ¶ˆä»Šå¤©ç´€éŒ„");
    }
    return;
  }

  // ç·¨è¼¯ç¿’æ…£
  if (e.target.classList.contains("editBtn")) {
    const habit = habits.find(h => h.id === id);
    if (!habit) return;
    const action = prompt(
      "è¼¸å…¥æ–°åç¨±ï¼Œæˆ–è¼¸å…¥ DELETE åˆªé™¤æ­¤ç¿’æ…£ï¼š",
      habit.name
    );
    if (action === null) return;
    if (action === "DELETE") {
      if (confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹ç¿’æ…£å—ï¼Ÿæ­·å²ç´€éŒ„ä¹Ÿæœƒä¸€èµ·åˆªæ‰ã€‚")) {
        habits = habits.filter(h => h.id !== id);
        delete calendar[id];
        saveHabits(habits);
        saveCalendar(calendar);
        renderHabits();
        showHUD("å·²åˆªé™¤ç¿’æ…£");
      }
    } else {
      habit.name = action;
      const newDesc = prompt("å¯é¸ï¼šæ›´æ–°æè¿°ï¼ˆç•™ç©ºå°±ä¸æ”¹ï¼‰", habit.desc || "");
      if (newDesc !== null && newDesc !== "") {
        habit.desc = newDesc;
      }
      saveHabits(habits);
      renderHabits();
      showHUD("å·²æ›´æ–°ç¿’æ…£");
    }
  }
});

/* ========= æ–°å¢ç¿’æ…£ ========= */
document.getElementById("btnAddHabit").addEventListener("click", () => {
  const name = prompt("ç¿’æ…£åç¨±ï¼ˆä¾‹å¦‚ï¼šæ¯å¤©å¯« 2 é¡Œæ•¸å­¸ï¼‰");
  if (!name) return;
  const desc = prompt("ç°¡çŸ­æè¿°ï¼ˆå¯ç•™ç©ºï¼‰", "ä½ æƒ³è¦æ±‚è‡ªå·±çš„å…·é«”æ¨™æº–ï¼Œä¾‹å¦‚è®€æ›¸å¤šä¹…ç®—å®Œæˆ");
  const id = "h_" + Date.now();
  habits.push({id, name, desc: desc || ""});
  saveHabits(habits);
  renderHabits();
  showHUD("å·²æ–°å¢ç¿’æ…£");
});

/* ========= æ›ä¸€å¥èªéŒ„ ========= */
document.getElementById("btnNewQuote").addEventListener("click", () => {
  pickQuote();
});

/* ========= å¹´åº¦ç†±åŠ›åœ– ========= */
const yearPanel  = document.getElementById("yearPanel");
const yearGrid   = document.getElementById("yearGrid");
const btnYear    = document.getElementById("btnYearView");
const btnCloseYear = document.getElementById("btnCloseYear");

function daysInMonth(year, month) {
  return new Date(year, month + 1, 0).getDate();
}

function renderYearHeatmap() {
  yearGrid.innerHTML = "";
  const now  = new Date();
  const year = now.getFullYear();

  // é å…ˆç®—å‡ºæ¯ä¸€å¤©å®Œæˆå¹¾å€‹ç¿’æ…£
  const dateDoneCount = {};
  habits.forEach(h => {
    const byHabit = calendar[h.id] || {};
    Object.keys(byHabit).forEach(k => {
      const d = new Date(k);
      if (d.getFullYear() !== year) return;
      dateDoneCount[k] = (dateDoneCount[k] || 0) + 1;
    });
  });

  for (let m = 0; m < 12; m++) {
    const monthDiv = document.createElement("div");
    monthDiv.className = "yearMonth";

    const title = document.createElement("div");
    title.className = "yearMonthTitle";
    title.textContent = `${year} å¹´ ${m+1} æœˆ`;
    monthDiv.appendChild(title);

    const daysWrap = document.createElement("div");
    daysWrap.className = "yearDays";

    const firstDay = new Date(year, m, 1).getDay(); // 0(æ—¥)~6(å…­)
    // ç©ºæ ¼è£œé½Šå‰é¢çš„ weekday
    for (let i = 0; i < firstDay; i++) {
      const empty = document.createElement("div");
      empty.className = "yearDay heat0";
      daysWrap.appendChild(empty);
    }

    const dim = daysInMonth(year, m);
    for (let d = 1; d <= dim; d++) {
      const dateObj = new Date(year, m, d);
      const key = dateObj.toISOString().slice(0,10);
      const count = dateDoneCount[key] || 0;
      let level = "heat0";
      if (count === 1) level = "heat1";
      else if (count === 2) level = "heat2";
      else if (count >= 3) level = "heat3";

      const box = document.createElement("div");
      box.className = "yearDay " + level;
      daysWrap.appendChild(box);
    }

    monthDiv.appendChild(daysWrap);
    yearGrid.appendChild(monthDiv);
  }
}

btnYear.addEventListener("click", () => {
  renderYearHeatmap();
  yearPanel.style.display = "flex";
});

btnCloseYear.addEventListener("click", () => {
  yearPanel.style.display = "none";
});

/* ========= å•Ÿå‹•å„€å¼ (2 åˆ†é˜å€’æ•¸) ========= */
const startPanel    = document.getElementById("startPanel");
const startTimerEl  = document.getElementById("startTimer");
const btnStartRitual= document.getElementById("btnStartRitual");
const btnCancelStart= document.getElementById("btnCancelStart");
const btnBeginStart = document.getElementById("btnBeginStart");

let startCountdownId = null;
let startSecondsLeft = 120;

function updateStartTimer() {
  const m = String(Math.floor(startSecondsLeft/60)).padStart(2,"0");
  const s = String(startSecondsLeft%60).padStart(2,"0");
  startTimerEl.textContent = `${m}:${s}`;
}

function openStartPanel() {
  // é‡ç½®
  startSecondsLeft = 120;
  updateStartTimer();
  startPanel.style.display = "flex";
}

function closeStartPanel() {
  startPanel.style.display = "none";
  if (startCountdownId) {
    clearInterval(startCountdownId);
    startCountdownId = null;
  }
}

btnStartRitual.addEventListener("click", openStartPanel);
btnCancelStart.addEventListener("click", closeStartPanel);

btnBeginStart.addEventListener("click", () => {
  if (startCountdownId) return; // å·²ç¶“åœ¨è·‘
  startSecondsLeft = 120;
  updateStartTimer();
  startCountdownId = setInterval(() => {
    startSecondsLeft--;
    if (startSecondsLeft <= 0) {
      clearInterval(startCountdownId);
      startCountdownId = null;
      updateStartTimer();
      closeStartPanel();
      showHUD("å•Ÿå‹•å®Œæˆã€‚\nå»åšä¸€ä»¶å°äº‹ï¼Œç„¶å¾Œé»äº®ä¸€é¡†æ˜Ÿ â­");
      if (navigator.vibrate) {
        try { navigator.vibrate(200); } catch(e){}
      }
      return;
    }
    updateStartTimer();
  }, 1000);
});

/* ========= Conway èƒŒæ™¯ ========= */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");
let cols, rows, grid;
const cellSize = 7;

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
  cols = Math.floor(innerWidth / cellSize);
  rows = Math.floor(innerHeight / cellSize);
  randomGrid();
}
window.addEventListener("resize", resize);
resize();

function randomGrid() {
  grid = Array.from({length: rows}, () =>
    Array.from({length: cols}, () => Math.random() < 0.12 ? 1 : 0)
  );
}

function nextGen() {
  let ng = grid.map(r => [...r]);
  for (let y=0;y<rows;y++){
    for (let x=0;x<cols;x++){
      let n=0;
      for (let dy=-1;dy<=1;dy++)
        for (let dx=-1;dx<=1;dx++)
          if(dx||dy) n+=grid[(y+dy+rows)%rows][(x+dx+cols)%cols];
      ng[y][x]=(n===3||n===2&&grid[y][x])?1:0;
    }
  }
  grid = ng;
}

function draw() {
  ctx.fillStyle = "#05060f";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = "#4fa3ff2a";
  for (let y=0;y<rows;y++){
    for (let x=0;x<cols;x++){
      if(grid[y][x]) ctx.fillRect(x*cellSize,y*cellSize,cellSize,cellSize);
    }
  }
}

function loop() {
  nextGen();
  draw();
  requestAnimationFrame(loop);
}
loop();

/* ========= âš¡ é‡ç”Ÿå®‡å®™ ========= */
document.getElementById("btnUniverse").addEventListener("click", () => {
  randomGrid();
  showHUD("âš¡ æ–°å®‡å®™");
});

/* ========= åˆå§‹åŒ– ========= */
pickQuote();
renderHabits();
</script>
</body>
</html>