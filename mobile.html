<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Conway Study OS - Mobile</title>

  <!-- iOS / 手機友善 -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="StudyOS">

  <style>
    * { box-sizing: border-box; }
    body {
      margin: 0;
      overflow: hidden;
      background: #05060d;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
                   "Segoe UI", sans-serif;
      color: #e5e9ff;
    }

    canvas {
      position: fixed;
      inset: 0;
    }

    /* 中央資訊區 */
    #center {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      text-align: center;
      text-shadow: 0 0 18px rgba(0,0,0,0.8);
      z-index: 10;
      padding: 0 16px;
    }
    #center .mode {
      font-size: 26px;
      letter-spacing: 4px;
      opacity: 0.8;
      margin-bottom: 8px;
    }
    #center .main {
      font-size: 56px;
      font-weight: 600;
      margin-bottom: 8px;
    }
    #center .sub {
      font-size: 16px;
      opacity: 0.85;
    }

    /* 上方顯示「現在這一段行程」 */
    #currentBlock {
      position: fixed;
      top: env(safe-area-inset-top, 12px);
      left: 50%;
      transform: translateX(-50%);
      background: rgba(5,10,30,0.8);
      padding: 6px 16px;
      border-radius: 999px;
      border: 1px solid rgba(120,140,255,0.5);
      font-size: 14px;
      z-index: 10;
      max-width: 90%;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* 下方控制列 */
    #toolbar {
      position: fixed;
      left: 0;
      right: 0;
      bottom: env(safe-area-inset-bottom, 0px);
      padding: 10px 12px calc(10px + env(safe-area-inset-bottom, 0px));
      z-index: 20;
      display: flex;
      justify-content: center;
    }

    #toolbarInner {
      background: rgba(5,5,20,0.9);
      backdrop-filter: blur(12px);
      border-radius: 999px;
      padding: 6px 10px;
      display: flex;
      gap: 6px;
      box-shadow: 0 0 18px rgba(0,0,0,0.7);
    }

    #toolbarInner button {
      border: none;
      padding: 8px 12px;
      border-radius: 999px;
      background: #141a33;
      color: #e5e9ff;
      font-size: 13px;
      font-family: inherit;
      min-width: 52px;
    }
    #toolbarInner button.primary {
      background: #2d5bff;
    }
    #toolbarInner button.danger {
      background: #ff4b7a;
    }
    #toolbarInner button:active {
      transform: scale(0.96);
    }

    /* 編輯行程面板（手機版） */
    #planPanel {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      backdrop-filter: blur(12px);
      display: none;
      z-index: 30;
      align-items: center;
      justify-content: center;
      padding: 16px;
    }

    #planBox {
      width: 100%;
      max-width: 420px;
      background: #0b0d1a;
      border-radius: 14px;
      border: 1px solid #444c88;
      padding: 12px;
      box-shadow: 0 0 24px rgba(0,0,0,0.8);
    }

    #planTitle {
      font-size: 17px;
      margin-bottom: 6px;
    }
    #planHint {
      font-size: 12px;
      opacity: 0.7;
      margin-bottom: 8px;
    }

    #planArea {
      width: 100%;
      height: 180px;
      border-radius: 10px;
      border: 1px solid #3c4370;
      background: #050616;
      color: #e9ecff;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 13px;
      padding: 8px;
      resize: none;
    }

    #planButtons {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 8px;
      font-size: 13px;
    }

    #planButtons button {
      border-radius: 999px;
      border: none;
      padding: 6px 12px;
      font-family: inherit;
      font-size: 13px;
    }

    /* 中央 HUD 提示（行程切換） */
    #toast {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(255,255,255,0.92);
      color: #000;
      padding: 14px 22px;
      border-radius: 10px;
      font-size: 20px;
      font-family: ui-monospace, monospace;
      box-shadow: 0 0 24px rgba(255,255,255,0.9);
      opacity: 0;
      pointer-events: none;
      z-index: 40;
      transition: opacity 0.4s ease-out;
      max-width: 90%;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
  </style>
</head>
<body>
<canvas id="bg"></canvas>

<!-- 顯示目前這一段行程 -->
<div id="currentBlock"></div>

<!-- 中央時間 / 番茄模式 -->
<div id="center">
  <div class="mode" id="centerMode">TIME</div>
  <div class="main" id="centerMain">00:00</div>
  <div class="sub" id="centerSub"></div>
</div>

<!-- 下方工具列 -->
<div id="toolbar">
  <div id="toolbarInner">
    <button class="primary" id="btnPomo">▶︎ Pomo</button>
    <button id="btnMode">Mode</button>
    <button id="btnPlan">Plan</button>
    <button class="danger" id="btnUniverse">⚡</button>
  </div>
</div>

<!-- 編輯行程 -->
<div id="planPanel">
  <div id="planBox">
    <div id="planTitle">編輯今日行程</div>
    <div id="planHint">格式：<br>07:00-09:00 數學<br>09:00-10:30 物理</div>
    <textarea id="planArea"></textarea>
    <div id="planButtons">
      <button id="btnCancel">取消</button>
      <button id="btnSave" style="background:#2d5bff; color:white;">儲存</button>
    </div>
  </div>
</div>

<!-- 中央 HUD 提示 -->
<div id="toast"></div>

<script>
/* ========== 基本 DOM ========== */
const canvas = document.getElementById("bg");
const ctx = canvas.getContext("2d");

const centerMode = document.getElementById("centerMode");
const centerMain = document.getElementById("centerMain");
const centerSub  = document.getElementById("centerSub");
const currentBlockDiv = document.getElementById("currentBlock");

const btnPomo     = document.getElementById("btnPomo");
const btnMode     = document.getElementById("btnMode");
const btnPlan     = document.getElementById("btnPlan");
const btnUniverse = document.getElementById("btnUniverse");

const planPanel   = document.getElementById("planPanel");
const planArea    = document.getElementById("planArea");
const btnCancel   = document.getElementById("btnCancel");
const btnSave     = document.getElementById("btnSave");

const toast       = document.getElementById("toast");

/* ========== Conway ==========
   手機版也保留永動背景，但略微溫和一點 */
const cellSize = 7;
let cols, rows;
let grid = [];
let frame = 0;
let speed = 2;

function resize() {
  canvas.width = window.innerWidth;
  canvas.height = window.innerHeight;
  cols = Math.floor(canvas.width / cellSize);
  rows = Math.floor(canvas.height / cellSize);
  randomGrid();
}
window.addEventListener("resize", resize);

function randomGrid() {
  grid = Array.from({length: rows}, () =>
    Array.from({length: cols}, () => Math.random() > 0.82 ? 1 : 0)
  );
}
resize();

let freezeCounter = 0;
let lastGridHash  = "";
let lastSeedTime  = Date.now();
const seedInterval = 10000;

function gridHash() {
  return grid.map(r => r.join("")).join("|");
}

function injectSeeds() {
  for (let i = 0; i < 50; i++) {
    const x = Math.floor(Math.random() * cols);
    const y = Math.floor(Math.random() * rows);
    grid[y][x] = 1;
  }
}

function nextGen() {
  let newGrid = grid.map(r => [...r]);
  for (let y = 0; y < rows; y++) {
    for (let x = 0; x < cols; x++) {
      let n = 0;
      for (let dy=-1; dy<=1; dy++)
        for (let dx=-1; dx<=1; dx++)
          if (dx || dy) n += grid[(y+dy+rows)%rows][(x+dx+cols)%cols];
      newGrid[y][x] = (n===3 || (n===2 && grid[y][x])) ? 1 : 0;
    }
  }
  grid = newGrid;

  const h = gridHash();
  if (h === lastGridHash) freezeCounter++;
  else freezeCounter = 0;
  lastGridHash = h;

  if (freezeCounter > 40) {
    randomGrid();
    freezeCounter = 0;
  }
}

function drawConway() {
  ctx.fillStyle = "#05060f";
  ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = "#4fa3ff2a";
  for (let y=0; y<rows; y++)
    for (let x=0; x<cols; x++)
      if (grid[y][x])
        ctx.fillRect(x*cellSize, y*cellSize, cellSize, cellSize);
}

/* ========== 番茄 & 時鐘 ========== */
let focusMinutes = 25;
let breakMinutes = 5;

let mode = "FOCUS";
let secondsLeft = focusMinutes * 60;
let pomoRunning = false;
let pomoActive  = false;

function applyMode() {
  secondsLeft = (mode === "FOCUS" ? focusMinutes : breakMinutes) * 60;
}

setInterval(() => {
  if (!pomoActive || !pomoRunning) return;
  secondsLeft--;
  if (secondsLeft <= 0) {
    mode = (mode === "FOCUS") ? "BREAK" : "FOCUS";
    applyMode();
    showToast(mode === "FOCUS" ? "回到 FOCUS" : "休息時間");
  }
}, 1000);

/* ========== 行程 / 時間區塊 ========== */
let WAKE_TIME  = "07:00";
let SLEEP_TIME = "23:00";

let schedule = [
  {start:"07:00", end:"09:00", label:"數學"},
  {start:"09:00", end:"10:30", label:"物理"},
  {start:"10:30", end:"11:00", label:"休息"},
  {start:"11:00", end:"12:00", label:"英文"}
];
if (localStorage.mobileTimeline) {
  try { schedule = JSON.parse(localStorage.mobileTimeline); } catch(e){}
}

function timeToMin(t) {
  const [h,m] = t.split(":").map(Number);
  return h*60+m;
}

let lastBlock = null;

function showToast(msg) {
  toast.textContent = msg;
  toast.style.opacity = 0;
  setTimeout(()=>{
    toast.style.opacity = 1;
  },10);
  setTimeout(()=>{
    toast.style.opacity = 0;
  },1000);
}

function updateCurrentBlock() {
  const nowStr = new Date().toTimeString().slice(0,5);
  const nowMin = timeToMin(nowStr);

  let current = null;
  for (let blk of schedule) {
    if (nowMin >= timeToMin(blk.start) && nowMin < timeToMin(blk.end)) {
      current = blk;
    }
  }

  if (current && (!lastBlock || current.label !== lastBlock.label)) {
    if (lastBlock) {
      showToast(`${lastBlock.label} ➜ ${current.label}`);
    }
  }
  lastBlock = current;

  if (current) {
    currentBlockDiv.textContent = `${current.start}-${current.end}  ${current.label}`;
    currentBlockDiv.style.display = "block";
  } else {
    currentBlockDiv.textContent = "";
    currentBlockDiv.style.display = "none";
  }
}

/* ========== 中央顯示 ========== */
function updateCenter() {
  const now = new Date();
  const hh = String(now.getHours()).padStart(2,"0");
  const mm = String(now.getMinutes()).padStart(2,"0");

  if (!pomoActive) {
    centerMode.textContent = "TIME";
    centerMain.textContent = `${hh}:${mm}`;
    centerSub.textContent  = "";
  } else {
    centerMode.textContent = mode;
    const m = String(Math.floor(secondsLeft/60)).padStart(2,"0");
    const s = String(secondsLeft%60).padStart(2,"0");
    centerMain.textContent = `${m}:${s}`;
    centerSub.textContent  = (mode==="FOCUS" ? "專注中" : "休息中");
  }
}

/* ========== 主迴圈 ========== */
function mainLoop() {
  frame++;

  if (frame % (4 - speed) === 0) {
    nextGen();
  }

  const now = Date.now();
  if (now - lastSeedTime >= seedInterval) {
    injectSeeds();
    lastSeedTime = now;
  }

  drawConway();
  updateCenter();
  updateCurrentBlock();

  requestAnimationFrame(mainLoop);
}
mainLoop();

/* ========== 行程編輯面板邏輯 ========== */
function openPlan() {
  planArea.value = schedule.map(s=>`${s.start}-${s.end} ${s.label}`).join("\n");
  planPanel.style.display = "flex";
}
function closePlan() {
  planPanel.style.display = "none";
}
function savePlan() {
  const lines = planArea.value.split("\n");
  const newList = [];
  for (let line of lines) {
    const m = line.match(/(\d\d:\d\d)-(\d\d:\d\d)\s+(.+)/);
    if (m) newList.push({start:m[1], end:m[2], label:m[3]});
  }
  if (newList.length > 0) {
    schedule = newList;
    localStorage.mobileTimeline = JSON.stringify(schedule);
  }
  closePlan();
}

btnPlan.addEventListener("click", openPlan);
btnCancel.addEventListener("click", closePlan);
btnSave.addEventListener("click", savePlan);

/* ========== 下方按鈕事件 ========== */

// ▶︎ Pomo
btnPomo.addEventListener("click", () => {
  if (!pomoActive) {
    // 啟動番茄模式
    pomoActive  = true;
    pomoRunning = true;
    applyMode();
    btnPomo.textContent = "⏸";
  } else {
    // 暫停 / 繼續
    pomoRunning = !pomoRunning;
    btnPomo.textContent = pomoRunning ? "⏸" : "▶︎";
  }
});

// Mode：在番茄模式中切換 FOCUS / BREAK
btnMode.addEventListener("click", () => {
  mode = (mode === "FOCUS") ? "BREAK" : "FOCUS";
  if (pomoActive) applyMode();
  showToast(mode === "FOCUS" ? "FOCUS" : "BREAK");
});

// ⚡ 重生宇宙
btnUniverse.addEventListener("click", () => {
  randomGrid();
  showToast("新宇宙 ⚡");
});

// 讓點擊畫面不會把焦點亂跑
canvas.addEventListener("mousedown", e => e.preventDefault());
canvas.addEventListener("touchstart", e => e.preventDefault(), {passive:false});
</script>
</body>
</html>
